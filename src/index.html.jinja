<html>
<head>
    <script src="https://unpkg.com/htmx.org@1.9.6" integrity="sha384-FhXw7b6AlE/jyjlZH5iHa/tTe9EpJ1Y55RjcgPbjeWMskSxZt1v9qkxLJWNJaGni" crossorigin="anonymous"></script>
    <link href="{{url_for('static',path='/output.css')}}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vega@5.25.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.16.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.22.2"></script>
</head>
<body>
    <form class="relative" hx-post="/post_english_query" hx-target="#iql_query">
        {% block english_query %}
        <input name="english_query" type="text" id="english_query" class="w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Ask a question" required>
        {% endblock %}
        <button id="english_query_button"  type="submit" class="text-white absolute right-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Ask</button>
    </form>
    <form hx-post="/post_iql_query" hx-target="#plot">
        <div class="relative" id="iql_query">
            {% block iql_query %}
            <input name="iql_query" value="{{ iql_query }}" type="text" id="iql_query" class="block w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="You can edit queries here" required>
            <button type="submit" id="iql_query_button" class="text-white absolute right-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Run</button>
            {% endblock %}
        </div>
        {% block plot %}
        <div class="flex justify-center" hx-get="/update_plot">
            <div id="plot" />
            <script type="text/javascript">
                var spec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                    "width": 600,
                    "height": 300,
                    "data": {
                    "url": "/query_result.csv"
                    },
                {% if plot_type == "qq" %}
                "encoding": {
                    "x": {
                        "field": "{{ var1 }}",
                        "type": "quantitative"
                    },
                    "y": {
                        "field": "{{ var2 }}",
                        "type": "quantitative"
                    }
                    },
                    "mark": {"type": "point"}
                {% elif plot_type == "nn" %}
                "encoding": {
                    "x": {
                    "field": "{{ var1 }}",
                    "type": "nominal"
                    },
                    "y": {
                    "field": "{{ var2 }}",
                    "type": "nominal"
                    },
                    "color": {
                    "aggregate": "count",
                    "type": "quantitative"
                    }
                },
                "mark": {"type": "rect"},
                "config": {
                    "view": {
                    "stroke": "transparent"
                    }
                }
                {% elif plot_type == "qn" %}
                "mark": {"type": "area", "opacity": .65},
                "transform": [
                {
                    "density": "{{ var1 }}",
                    "groupby": ["{{ var2 }}"],
                    "function": "kde",
                    "extent": {{ var1_extent }}
                }
                ],
                "encoding": {
                "x": {"field": "value", "type": "quantitative", "title": "{{ var1 }}", "scale": {"domain": {{ var1_extent }} }},
                "y": {"field": "density", "type": "quantitative"},
                "color": {"field": "{{ var2 }}", "type": "nominal"}
                },
                {%- endif %}
                };
                var opt = {"renderer": "canvas", "actions": false};
                vegaEmbed("#plot", spec, opt);
                </script>
        </div>
        {% endblock %}
        </form>
</body>
</html>