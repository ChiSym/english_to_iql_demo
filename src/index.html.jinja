<html>
<head>
    <script src="https://unpkg.com/htmx.org@1.9.6" integrity="sha384-FhXw7b6AlE/jyjlZH5iHa/tTe9EpJ1Y55RjcgPbjeWMskSxZt1v9qkxLJWNJaGni" crossorigin="anonymous"></script>
    <link href="{{url_for('static',path='/output.css')}}" rel="stylesheet">
    <script type="importmap">
      {
        "imports": {
          "@lit-labs/observers/mutation-controller.js":  "https://esm.sh/@lit-labs/observers@2.0.0/mutation-controller.js",
          "json5": "https://esm.sh/json5@2.2.3",
          "lit": "https://esm.sh/lit@2.8.0",
          "lit-html/directives/if-defined": "https://esm.sh/lit-html@3.0.0/directives/if-defined.js",
          "lit/directives/live.js": "https://esm.sh/lit@2.8.0/directives/live.js",
          "lit/directives/ref.js": "https://esm.sh/lit@2.8.0/directives/ref.js",
          "papaparse": "https://esm.sh/papaparse@5.4.1",
          "vega-embed": "https://esm.sh/vega-embed@6.23.0"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script type="module" src="{{url_for('static',path='/iql-language.mjs')}}"></script>
    <script type="module" src="{{url_for('static',path='/iql-code.mjs')}}"></script>
    <script type="module" src="{{url_for('static',path='/iql-textarea.mjs')}}"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.25.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.16.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.22.2"></script>
</head>
<body>
    <div class="mx-10">
    <div class="grid grid-col-3 gap-10 mt-10">
        <form class="relative col-span-3" hx-post="/post_english_query" hx-target="#iql_query">
            {% block english_query %}
            <label for="message" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">English</label>
            <textarea name="english_query" rows=2 id="english_query" placeholder="Ask a question" class="resize-none w-full text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"></textarea>    
            {% endblock %}
            <button id="english_query_button"  type="submit" class="absolute bottom-0 right-1 font-medium text-sm px-3 py-1.5 mb-1 text-white bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-200" >Ask</button>
        </form>
        <form id="iql_query" class="relative" hx-post="/post_iql_query" hx-target="#plot" hx-trigger="submit">
            {% block iql_query %}
            <label for="message" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">InferenceQL</label>
            <iql-textarea name="iql_query" id="iql_textarea">{{ iql_query }}</iql-textarea>
            <button id="iql_query_button" type="submit" class="z-10 absolute bottom-20 right-1 font-medium text-sm px-3 py-1.5 mb-1 text-white bg-blue-700 rounded-lg focus:ring-4 focus:ring-blue-200">Run</button>
            {% endblock %}
        </form>
        {% block plot %}
        <div class="col-span-2 justify-self-end" id="plot" hx-get="/update_plot">
            <label for="message" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Result</label>
            <div id="vis" />
            <script type="text/javascript">
                var spec = {{ chart | tojson }} ;
                var opt = {"renderer": "canvas", "actions": false};
                vegaEmbed("#vis", spec, opt);
                </script>
        </div>
        {% endblock %}
    </div>
    </div>
    <script>
        document.getElementById('iql_query').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            formData.set('iql_query', document.getElementById("iql_textarea")._content);
            
            fetch('/post_iql_query', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('plot').innerHTML = html;
            });
        });


    </script>
</body>
</html>